#!/bin/bash

LOGFILE="/var/log/user_management.log"
PASSWORD_FILE="/var/secure/user_passwords.txt"

# Ensure the secure directory exists and is readable only by root
mkdir -p /var/secure
chmod 700 /var/secure
touch $PASSWORD_FILE
chmod 600 $PASSWORD_FILE

log_action() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a $LOGFILE
}

create_group() {
    group=$1
    if ! getent group $group > /dev/null 2>&1; then
        groupadd $group
        log_action "Group $group created."
    else
        log_action "Group $group already exists."
    fi
}

create_user() {
    username=$1
    group=$2
    if ! id -u $username > /dev/null 2>&1; then
        useradd -m -g $group -s /bin/bash $username
        log_action "User $username created and added to group $group."
        
        # Generate a random password
        password=$(openssl rand -base64 12)
        
        # Set the password for the user
        echo "$username:$password" | chpasswd
        log_action "Password set for user $username."
        
        # Store the password securely
        echo "$username:$password" >> $PASSWORD_FILE
        log_action "Password for user $username stored securely."
        
        # Set permissions for the home directory
        chmod 700 /home/$username
        chown $username:$group /home/$username
        log_action "Permissions set for /home/$username."
    else
        log_action "User $username already exists."
    fi
}

# Example groups and users
groups=("group1" "group2")
users=("user1:group1" "user2:group2")

for group in "${groups[@]}"; do
    create_group $group
done

for user in "${users[@]}"; do
    IFS=":" read username group <<< "$user"
    create_user $username $group
done

log_action "User and group setup completed."

